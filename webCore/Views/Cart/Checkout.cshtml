@model webCore.Models.CheckoutViewModel

@{
    Layout = "_Layout";
    ViewData["Title"] = "Thanh toán";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="~/css/checkout.css" asp-append-version="true" />
}

<div class="checkout-page">
    <div class="container">
        <div class="page-header">
            <h2 class="page-title">THÔNG TIN THANH TOÁN</h2>
            <div class="checkout-steps">
                <div class="step active">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Giỏ hàng</span>
                </div>
                <div class="step-line active"></div>
                <div class="step active">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Xác nhận</span>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <i class="fas fa-credit-card"></i>
                    <span>Thanh toán</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 col-md-12 mb-4">
                <div class="checkout-products">
                    <div class="products-header">
                        <i class="fas fa-box"></i>
                        <h4>Sản phẩm đã chọn</h4>
                    </div>

                    <div class="products-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="product-col">Sản phẩm</th>
                                    <th class="price-col">Đơn giá</th>
                                    <th class="quantity-col">Số lượng</th>
                                    <th class="total-col">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Items != null && Model.Items.Any())
                                {
                                    foreach (var item in Model.Items)
                                    {
                                        var discountedPrice = item.Price * (1 - item.DiscountPercentage / 100);
                                        var itemTotal = discountedPrice * item.Quantity;

                                        <tr class="product-item">
                                            <td class="product-info">
                                                <div class="d-flex align-items-center">
                                                    @if (!string.IsNullOrEmpty(item.Image))
                                                    {
                                                        <img src="@item.Image" alt="@item.Title" class="product-image" />
                                                    }
                                                    else
                                                    {
                                                        <div class="product-image-placeholder">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    }
                                                    <div class="product-details">
                                                        <span class="product-title">@item.Title</span>
                                                        @if (item.DiscountPercentage > 0)
                                                        {
                                                            <span class="discount-badge">-@item.DiscountPercentage%</span>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="price-cell">
                                                <div class="price-wrapper">
                                                    <span class="current-price">@discountedPrice.ToString("#,##0") đ</span>
                                                    @if (item.DiscountPercentage > 0)
                                                    {
                                                        <small class="original-price">@item.Price.ToString("#,##0") đ</small>
                                                    }
                                                </div>
                                            </td>
                                            <td class="quantity-cell">
                                                <span class="quantity-badge">x @item.Quantity</span>
                                            </td>
                                            <td class="total-cell">
                                                <strong class="item-total">@itemTotal.ToString("#,##0") đ</strong>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="4" class="text-center empty-products">
                                            <i class="fas fa-box-open fa-3x mb-3"></i>
                                            <p>Không có sản phẩm nào</p>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12">
                <div class="checkout-summary">
                    <div class="discount-box">
                        <div id="error-message" class="alert alert-danger" role="alert" style="display: none;"></div>
                        <h4>Khuyến mãi</h4>
                        @if (!string.IsNullOrEmpty(Model.VoucherDiscount))
                        {
                            <p id="voucher-discount"><i class="fa-solid fa-tag"></i> Giảm @Model.VoucherDiscount %</p>
                        }
                        else
                        {
                            <p id="voucher-discount"><i class="fa-solid fa-tag"></i> Không có khuyến mãi.</p>
                        }
                        <a href="@Url.Action("VoucherClient", "VoucherClient")" onclick="sessionStorage.setItem('ReturnUrl', 'checkout')" class="apply-discount">Chọn hoặc nhập khuyến mãi khác</a>
                    </div>

                    <hr class="summary-divider" />

                    <div class="price-summary">
                        <h4><i class="fas fa-calculator"></i> Chi tiết thanh toán</h4>

                        <div class="summary-row">
                            <span class="summary-label">Tạm tính:</span>
                            <span class="summary-value">@Model.TotalAmount.ToString("#,##0") đ</span>
                        </div>

                        <div class="summary-row discount-row">
                            <span class="summary-label">
                                <i class="fas fa-tag"></i> Giảm giá:
                            </span>
                            <span class="summary-value discount-value">
                                -@Model.DiscountAmount.ToString("#,##0") đ
                            </span>
                        </div>

                        <hr class="summary-divider" />

                        <div class="summary-row total-row">
                            <span class="summary-label">Tổng cộng:</span>
                            <span class="summary-value total-value">@Model.FinalAmount.ToString("#,##0") đ</span>
                        </div>
                    </div>

                    <div class="payment-note">
                        <i class="fas fa-info-circle"></i>
                        <span>Bạn sẽ được chuyển đến trang thanh toán sau khi nhấn nút bên dưới</span>
                    </div>

                    <div class="payment-actions">
                        <a href="/Checkout/PaymentInfo" class="btn btn-payment">
                            <i class="fas fa-lock"></i> Tiến hành thanh toán
                        </a>
                        <a href="/Cart/Cart" class="btn btn-back">
                            <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                        </a>
                    </div>

                    <div class="security-badges">
                        <div class="security-item">
                            <i class="fas fa-shield-alt"></i>
                            <span>Bảo mật</span>
                        </div>
                        <div class="security-item">
                            <i class="fas fa-lock"></i>
                            <span>An toàn</span>
                        </div>
                        <div class="security-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Uy tín</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.product-item').each(function(index) {
                $(this).css('animation-delay', (index * 0.1) + 's');
            });
        });
    </script>
}