@model webCore.Models.Order

@{
    ViewData["Title"] = "Yêu cầu Trả hàng";
    Layout = "_Layout";
}

@section Styles {
    <style>
        /* Thêm style cho preview ảnh giống trang Review */
        .preview-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            justify-content: center;
        }

        .preview-item {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
    </style>
}

<div class="container">
    <div class="return-container">
        <div class="text-center mb-4">
            <h3 style="font-weight: 700; color: #333;">YÊU CẦU TRẢ HÀNG</h3>
        </div>

        <div class="header-info">
            <strong>Mã đơn hàng:</strong> <span class="text-primary">#@Model.Id</span>
            <br>
            <small class="text-muted">Ngày đặt: @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
        </div>

        <form asp-action="SubmitReturnRequest" asp-controller="Checkout" method="post" enctype="multipart/form-data" onsubmit="return confirmSubmit()">

            <input type="hidden" name="orderId" value="@Model.Id" />

            @if (Model.Items != null)
            {
                foreach (var item in Model.Items)
                {
                    <div class="product-box d-flex p-3 mb-3">
                        <img src="@item.Image" style="width:70px; height:70px; border-radius:8px; margin-right:15px; object-fit: cover;" />
                        <div>
                            <strong>@item.Title</strong><br>
                            <small>@item.Price.ToString("N0")đ x @item.Quantity</small>
                        </div>
                    </div>
                }
            }

            <hr />

            <div class="form-group">
                <label><strong>Lý do trả hàng & Mô tả</strong> <span class="text-danger">*</span></label>
                <textarea name="reason" class="form-control" rows="4" required placeholder="Mô tả chi tiết lý do..."></textarea>
            </div>

            <div class="form-group">
                <label><strong>Hình ảnh / Video minh chứng</strong></label>
                <div class="media-upload-area" onclick="document.getElementById('mediaInput').click()" style="cursor: pointer;">
                    <div class="media-upload">
                        <i class="fa fa-cloud-upload-alt"></i>
                        <div style="font-size: 13px;">Tải lên Ảnh/Video</div>
                    </div>
                </div>

                <input type="file" id="mediaInput" name="mediaFiles" multiple accept="image/*,video/*" style="display:none;" onchange="previewMedia(this)" />

                <div id="previewContainer" class="preview-container"></div>
            </div>

            <button type="submit" class="btn btn-primary btn-block btn-submit text-white mt-4">
                <i class="fas fa-paper-plane mr-2"></i> Gửi yêu cầu
            </button>
        </form>

        <div class="text-center mt-3">
            <a href="@Url.Action("PaymentHistory", "Checkout")" class="text-secondary small">
                <i class="fas fa-arrow-left"></i> Quay lại danh sách đơn hàng
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Hàm xem trước ảnh/video (Copy từ trang Review của bạn)
        function previewMedia(input) {
            var container = document.getElementById('previewContainer');
            container.innerHTML = '';
            if (input.files) {
                Array.from(input.files).forEach(file => {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var media;
                        if (file.type.startsWith('video')) {
                            media = document.createElement('video');
                            media.src = e.target.result;
                            media.className = 'preview-item';
                            media.controls = false; // Tắt control cho gọn
                        } else {
                            media = document.createElement('img');
                            media.src = e.target.result;
                            media.className = 'preview-item';
                        }
                        container.appendChild(media);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        // Xác nhận trước khi gửi
        function confirmSubmit() {
            return confirm("Bạn có chắc chắn muốn gửi yêu cầu trả hàng? Đơn hàng sẽ được hủy ngay sau khi gửi.");
        }
    </script>
}