@{
    ViewData["Title"] = "Thêm sản phẩm mới";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}
<link rel="stylesheet" href="/css/create_account.css" />

<div class="form-container">
    <h2>Thêm mới sản phẩm</h2>

    <!-- Alert giả - có thể ẩn/hiện bằng JavaScript -->
    <div class="alert alert-danger" style="display: none;" id="errorAlert">
        <ul id="errorList">
            <!-- Errors will be inserted here -->
        </ul>
    </div>

    <div class="alert alert-success" style="display: none;" id="successAlert">
        Sản phẩm đã được thêm thành công!
    </div>

    <form id="createProductForm" onsubmit="handleSubmit(event)">
        <label for="Title">Tên sản phẩm *</label>
        <input type="text" id="Title" name="Title" required placeholder="Nhập tên sản phẩm" />

        <label for="Image">Ảnh sản phẩm</label>
        <input type="file" id="Image" name="Image" accept="image/*" onchange="previewImage(event)" />
        <div class="image-preview-container">
            <img id="imagePreview" alt="Ảnh xem trước" style="max-width: 300px; display: none;" />
        </div>

        <label for="Description">Mô tả sản phẩm</label>
        <textarea id="Description" name="Description" style="width: 100%; height: 200px;" placeholder="Nhập mô tả chi tiết về sản phẩm"></textarea>

        <div class="status">
            <label>Đặc trưng:</label>
            <input type="radio" id="featured" name="featured" value="0" checked />
            <label for="featured" class="featured">Nổi bật</label>
            <input type="radio" id="new" name="featured" value="1" />
            <label for="new" class="new">Mới</label>
            <input type="radio" id="suggest" name="featured" value="2" />
            <label for="suggest" class="suggest">Gợi ý</label>
            <input type="radio" id="no" name="featured" value="3" />
            <label for="no" class="no">Không nổi bật</label>
        </div>

        <label for="CategoryId">Danh mục *</label>
        <select id="CategoryId" name="categoryId" class="form-control" required>
            <option value="">-- Chọn danh mục --</option>
        </select>

        <label for="Price">Giá bán (VNĐ) *</label>
        <input type="number" id="Price" name="Price" required placeholder="0" min="0" />

        <label for="DiscountPercentage">Giảm giá (%)</label>
        <input type="number" id="DiscountPercentage" name="DiscountPercentage" placeholder="0" min="0" max="100" />

        <label for="Stock">Số lượng trong kho *</label>
        <input type="number" id="Stock" name="Stock" required placeholder="0" min="0" />

        <div class="status">
            <label>Trạng thái</label>
            <input type="radio" id="active" name="Status" value="Hoạt động" checked />
            <label for="active" class="active">Hoạt động</label>
            <input type="radio" id="inactive" name="Status" value="Không hoạt động" />
            <label for="inactive" class="inactive">Dừng hoạt động</label>
        </div>

        <button type="submit">Tạo mới</button>
        <button type="button" onclick="window.history.back()" style="background-color: #6c757d; margin-top: 20px">Hủy</button>
    </form>
</div>

<script>
    async function loadCategories() {
        try {
            const res = await fetch('/api/product/create-data');
            const data = await res.json();

            const select = document.getElementById("CategoryId");
            select.innerHTML = `<option value="">-- Chọn danh mục --</option>`;

            // Render categories from MongoDB
            data.categories.forEach(cat => {
                select.innerHTML += `
                    <option value="${cat.id}">${cat.title}</option>
                `;
            });
        } catch (err) {
            console.error("Lỗi load danh mục", err);
        }
    }

    loadCategories();

    async function handleSubmit(event) {
        event.preventDefault();

        const form = document.getElementById("createProductForm");
        const formData = new FormData(form);

        // Append image
        const imageFile = document.getElementById("Image").files[0];
        if (imageFile) {
            formData.append("Image", imageFile);
        }

        // SellerId lấy từ localStorage nếu bạn vẫn dùng
        const sellerId = localStorage.getItem("SellerId") || "";
        formData.append("SellerId", sellerId);

        // Reset alerts
        document.getElementById("errorAlert").style.display = "none";
        document.getElementById("successAlert").style.display = "none";
        document.getElementById("errorList").innerHTML = "";

        try {
            const response = await fetch("/api/product/create", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                showError(result.message || "Đã xảy ra lỗi. Vui lòng thử lại.");
                return;
            }

            // Success
            document.getElementById("successAlert").style.display = "block";
            form.reset();
            document.getElementById("imagePreview").style.display = "none";

        } catch (err) {
            showError("Lỗi kết nối server!");
        }
    }

    function showError(message) {
        const errorAlert = document.getElementById("errorAlert");
        const errorList = document.getElementById("errorList");

        errorList.innerHTML = `<li>${message}</li>`;
        errorAlert.style.display = "block";
    }

    function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById("imagePreview");

        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = "block";
        }
    }
</script>

