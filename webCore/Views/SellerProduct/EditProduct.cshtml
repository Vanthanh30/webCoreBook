@{
    ViewData["Title"] = "Cập nhật sản phẩm";
    Layout = "~/Views/Shared/_SellerLayout.cshtml";
}
<link rel="stylesheet" href="/css/ProductManagement.css" />

<div class="form-container">
    <h2>Cập nhật sản phẩm</h2>

    <div id="loadingSpinner" style="text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
        <p>Đang tải dữ liệu...</p>
    </div>

    <div class="alert alert-danger" style="display: none;" id="errorAlert">
        <ul id="errorList"></ul>
    </div>

    <div class="alert alert-success" style="display: none;" id="successAlert">
        Sản phẩm đã được cập nhật thành công!
    </div>

    <form id="updateProductForm" onsubmit="handleSubmit(event)" style="display: none;">
        <input type="hidden" id="Id" name="Id" />

        <label for="Title">Tên sản phẩm *</label>
        <input type="text" id="Title" name="Title" required placeholder="Nhập tên sản phẩm" />

        <label for="Image">Hình ảnh</label>
        <input type="file" id="Image" name="Image" accept="image/*" onchange="previewImage(event)" />

        <div style="margin: 10px 0;" id="currentImageContainer">
            <p style="font-size: 14px; color: #666;">Ảnh hiện tại:</p>
            <img id="currentImage" src="" alt="Current Image"
                 style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; padding: 5px; border-radius: 4px;" />
        </div>

        <div style="margin: 10px 0;">
            <p style="font-size: 14px; color: #666; display: none;" id="previewLabel">Ảnh mới (xem trước):</p>
            <img id="imagePreview" alt="Image Preview"
                 style="max-width: 200px; max-height: 200px; display: none; border: 1px solid #ddd; padding: 5px; border-radius: 4px;" />
        </div>

        <label for="Description">Mô tả sản phẩm</label>
        <textarea id="Description" name="Description" style="width: 100%; height: 200px;" placeholder="Nhập mô tả chi tiết về sản phẩm"></textarea>

        <label>Đặc trưng</label>
        <div class="status">
            <input type="radio" id="highlighted" name="Featured" value="1" />
            <label for="highlighted" class="featured">Nổi bật</label>

            <input type="radio" id="new" name="Featured" value="2" />
            <label for="new" class="new">Mới</label>

            <input type="radio" id="suggest" name="Featured" value="3" />
            <label for="suggest" class="suggest">Gợi ý</label>

            <input type="radio" id="none" name="Featured" value="0" />
            <label for="none" class="no">Không nổi bật</label>
        </div>

        <label for="CategoryId">Danh mục *</label>
        <select id="CategoryId" name="categoryId" class="form-control" required>
            <option value="">-- Chọn danh mục --</option>
        </select>

        <div class="product-pricing-group">
            <div class="form-group-item">
                <label for="Price">Giá bán (VNĐ) *</label>
                <input type="number" id="Price" name="Price" required placeholder="0" min="0" />
            </div>

            <div class="form-group-item">
                <label for="DiscountPercentage">Giảm giá (%)</label>
                <input type="number" id="DiscountPercentage" name="DiscountPercentage" placeholder="0" min="0" max="100" />
            </div>

            <div class="form-group-item">
                <label for="Stock">Số lượng trong kho *</label>
                <input type="number" id="Stock" name="Stock" required placeholder="0" min="0" />
            </div>
        </div>
        <label id="statusLabel">Trạng thái</label>
        <div class="status" id="statusContainer">
            <input type="radio" id="statusActive" name="Status" value="Hoạt động" />
            <label for="statusActive" class="active">Hoạt động</label>

            <input type="radio" id="statusInactive" name="Status" value="Dừng hoạt động" />
            <label for="statusInactive" class="inactive">Dừng hoạt động</label>
        </div>

        <button type="submit" style="margin-top: 20px;">Cập nhật</button>
        <button type="button" onclick="window.history.back()" style="background-color: #6c757d; margin-top: 20px;">Hủy</button>
    </form>
</div>

<script>
    let productId = null;

    function getProductIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    async function loadProductData() {
        productId = getProductIdFromUrl();

        if (!productId) {
            alert('Không tìm thấy ID sản phẩm!');
            window.history.back();
            return;
        }

        try {
            const response = await fetch(`/api/product/edit/${productId}`);
            const result = await response.json();

            document.getElementById('loadingSpinner').style.display = 'none';

            if (!result.success) {
                alert(result.message || 'Lỗi khi tải dữ liệu');
                window.history.back();
                return;
            }

            const product = result.product;
            const categories = result.categories;

            document.getElementById('Id').value = product.id;
            document.getElementById('Title').value = product.title;
            document.getElementById('Description').value = product.description || '';
            document.getElementById('Price').value = product.price;
            document.getElementById('DiscountPercentage').value = product.discountPercentage || 0;
            document.getElementById('Stock').value = product.stock;

            if (product.image) {
                document.getElementById('currentImage').src = product.image;
                document.getElementById('currentImageContainer').style.display = 'block';
            } else {
                document.getElementById('currentImageContainer').style.display = 'none';
            }

            const featuredRadios = document.getElementsByName('Featured');
            featuredRadios.forEach(radio => {
                if (parseInt(radio.value) === product.featured) {
                    radio.checked = true;
                }
            });

            const statusRadios = document.getElementsByName('Status');
            const statusContainer = document.getElementById('statusContainer');
            const statusLabel = document.getElementById('statusLabel');
            statusRadios.forEach(radio => {
                if (radio.value === product.status) {
                    radio.checked = true;
                }
            });
            if (product.status === "Chờ duyệt") {
                statusLabel.style.display = "none";
                statusContainer.style.display = "none";
               
            }
            const categorySelect = document.getElementById('CategoryId');
            categorySelect.innerHTML = '<option value="">-- Chọn danh mục --</option>';
            categories.forEach(cat => {
                const selected = cat.id === product.categoryId ? 'selected' : '';
                categorySelect.innerHTML += `<option value="${cat.id}" ${selected}>${cat.title}</option>`;
            });

            document.getElementById('updateProductForm').style.display = 'block';

        } catch (error) {
            console.error('Error loading product:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            alert('Lỗi kết nối server!');
            window.history.back();
        }
    }

    async function handleSubmit(event) {
        event.preventDefault();

        const form = document.getElementById('updateProductForm');
        const formData = new FormData(form);

        const imageFile = document.getElementById('Image').files[0];
        if (imageFile) {
            formData.append('Image', imageFile);
        }

        document.getElementById('errorAlert').style.display = 'none';
        document.getElementById('successAlert').style.display = 'none';
        document.getElementById('errorList').innerHTML = '';

        try {
            const response = await fetch(`/api/product/update/${productId}`, {
                method: 'PUT',
                body: formData
            });

            const result = await response.json();

            if (!response.ok || !result.success) {
                showError(result.message || 'Đã xảy ra lỗi. Vui lòng thử lại.');
                return;
            }

            document.getElementById('successAlert').style.display = 'block';

            setTimeout(() => {
                window.location.href = '/SellerProduct/ProductManagement';
            }, 1500);

        } catch (err) {
            showError('Lỗi kết nối server!');
        }
    }

    function showError(message) {
        const errorAlert = document.getElementById('errorAlert');
        const errorList = document.getElementById('errorList');

        errorList.innerHTML = `<li>${message}</li>`;
        errorAlert.style.display = 'block';

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('imagePreview');
        const previewLabel = document.getElementById('previewLabel');

        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            previewLabel.style.display = 'block';
        } else {
            preview.style.display = 'none';
            previewLabel.style.display = 'none';
        }
    }

    loadProductData();
</script>