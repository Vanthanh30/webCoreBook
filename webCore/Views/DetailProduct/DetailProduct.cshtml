@model webCore.Models.Product_admin
@{
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/detail_product.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
}

<!-- BẢO VỆ NULL TOÀN BỘ TRANG -->
@if (Model == null)
{
    <div class="container py-5 text-center">
        <h2 class="text-danger">Không tìm thấy sản phẩm</h2>
        <p>Sản phẩm không tồn tại hoặc đã bị xóa.</p>
        <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Quay lại trang chủ</a>
    </div>
    return;
}

<div class="product-wrapper">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
        @if (ViewBag.Breadcrumbs is List<Category> breadcrumbs && breadcrumbs.Any())
        {
            for (int i = 0; i < breadcrumbs.Count; i++)
            {
                <span>@breadcrumbs[i].Title</span>
                @if (i < breadcrumbs.Count - 1)
                {
                    <span> > </span>
                }
            }
        }
    </div>

    <div class="main-row">
        <!-- Ảnh sản phẩm -->
        <div class="left-col">
            <img src="@(string.IsNullOrWhiteSpace(Model.Image) ? "/image/no-image.jpg" : Model.Image)"
                 alt="@Model.Title"
                 onerror="this.src='/image/no-image.jpg'" />
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="right-col">
            <h1 class="product-title">@Model.Title</h1>

            <!-- GIÁ – SỬA LỖI decimal / double -->
            <div style="margin:25px 0;">
                <span class="price-current">
                    @String.Format("{0:N0}", Model.Price * (1m - Model.DiscountPercentage / 100m)) đ
                </span>
                @if (Model.DiscountPercentage > 0)
                {
                    <span class="price-old">@String.Format("{0:N0}", Model.Price) đ</span>
                    <span class="discount">-@Model.DiscountPercentage%</span>
                }
            </div>

            <!-- Số lượng -->
            <div class="quantity-row">
                <label>Số lượng</label>
                <div class="quantity-input">
                    <button type="button" class="btn-minus">-</button>
                    <input type="text" id="quantitypr" value="1" readonly>
                    <button type="button" class="btn-plus">+</button>
                </div>
                <span style="margin-left:20px;color:#666;">
                    @(Model.Stock > 0 ? $"{Model.Stock} sản phẩm có sẵn" : "Hết hàng")
                </span>
            </div>

            <!-- Nút hành động -->
            <div class="buttons-row">
                <button class="add_button"
                        data-productid="@Model.Id"
                        data-title="@Model.Title"
                        data-price="@Model.Price"
                        data-discountpercentage="@Model.DiscountPercentage"
                        data-image="@Model.Image">
                    Thêm vào giỏ hàng
                </button>
                <button class="buy_button" id="btnBuyNow" data-productid="@Model.Id">
                    Mua ngay
                </button>
                <input type="hidden" id="quantityInput" value="1" />
            </div>

            <!-- Mô tả sản phẩm – BẢO VỆ NULL -->
            <div class="description">
                <h6>Mô tả sản phẩm</h6>
                @if (string.IsNullOrWhiteSpace(Model.Description))
                {
                    <p class="text-muted fst-italic">Chưa có mô tả cho sản phẩm này.</p>
                }
                else
                {
                    @Html.Raw(Model.Description.Replace(Environment.NewLine, "<br>"))
                }
            </div>
        </div>
    </div>
</div>

<!-- Sản phẩm tương tự -->
<div class="container my-5">
    <h4 class="fw-bold mb-4">Sản phẩm tương tự</h4>
    <div class="row g-4">
        @{
            var similarList = ViewBag.SimilarProducts as IEnumerable<dynamic>;
        }
        @if (similarList != null && similarList.Any())
        {
            @foreach (var p in similarList)
            {
                <div class="col-lg-3 col-md-4 col-6">
                    <div class="text-center border rounded p-3 shadow-sm h-100 d-flex flex-column">
                        <img src="@(string.IsNullOrWhiteSpace(p.Image) ? "/image/no-image.jpg" : p.Image)"
                             class="img-fluid rounded"
                             style="height:180px; object-fit:contain;"
                             alt="@p.Title">
                        <h6 class="my-3 flex-grow-1" style="font-size:15px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">
                            @p.Title
                        </h6>
                        <div class="mb-2">
                            <div style="color:#e74c3c; font-weight:700; font-size:18px;">
                                @String.Format("{0:N0} đ", p.Price * (1m - p.DiscountPercentage / 100m))
                            </div>
                            @if (p.DiscountPercentage > 0)
                            {
                                <del style="color:#aaa; font-size:14px;">@String.Format("{0:N0} đ", p.Price)</del>
                                <span style="color:#e74c3c;"> -@p.DiscountPercentage%</span>
                            }
                        </div>
                        <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = p.Id })"
                           class="btn btn-primary btn-sm mt-auto">Xem chi tiết</a>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">Chưa có sản phẩm tương tự.</p>
        }
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $('.btn-plus').click(function () {
            let val = parseInt($('#quantitypr').val()) + 1;
            if (val > 100) val = 100;
            if (val > @Model.Stock) val = @Model.Stock;
            $('#quantitypr').val(val);
            $('#quantityInput').val(val);
        });

        $('.btn-minus').click(function () {
            let val = parseInt($('#quantitypr').val()) - 1;
            if (val < 1) val = 1;
            $('#quantitypr').val(val);
            $('#quantityInput').val(val);
        });

        function addToCart(btn) {
            const data = {
                productId: $(btn).data('productid'),
                title: $(btn).data('title'),
                price: $(btn).data('price'),
                discountPercentage: $(btn).data('discountpercentage'),
                image: $(btn).data('image'),
                quantity: $('#quantitypr').val()
            };
            $.post('@Url.Action("AddToCart", "Cart")', data, function(res) {
                if (res.success) {
                    $(document).trigger('cartUpdated', [res.itemCount]);
                    alert(res.message);
                } else {
                    alert(res.message);
                }
            }).fail(() => alert('Lỗi khi thêm vào giỏ'));
        }

        $(function () {
            $('.add_button').click(function () { addToCart(this); });
            $('#btnBuyNow').click(function () {
                const pid = $(this).data('productid');
                const qty = $('#quantitypr').val();
                location.href = `/Cart/BuyNow?productId=${pid}&quantity=${qty}`;
            });
        });
    </script>
}