@model Tuple<List<webCore.Models.Order>, List<webCore.Models.ChatMessage>>
@using webCore.Controllers

<link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<input type="hidden" id="currentUserId" value="@ViewBag.CurrentUserId" />
<input type="hidden" id="selectedSellerId" value="@ViewBag.SelectedSellerId" />
<input type="hidden" id="selectedBuyerId" value="@ViewBag.SelectedBuyerId" />
<input type="hidden" id="isSeller" value="@ViewBag.IsSeller" />

<div class="chat-container">

    <!-- ======================== SIDEBAR =========================== -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h5>💬 @(ViewBag.IsSeller ? "Người mua" : "Người bán")</h5>

            <div class="search-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Tìm kiếm...">
            </div>
        </div>

        <div class="chat-list" id="chatList">
            @{
                var conversationList = (List<ConversationDisplay>)ViewBag.ConversationList ?? new List<ConversationDisplay>();
            }

            @if (!conversationList.Any())
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-dots fs-1"></i>
                    <p class="mt-2">Chưa có cuộc trò chuyện nào</p>
                </div>
            }
            else
            {
                @foreach (var conv in conversationList)
                {
                    var isActive = conv.OtherUserId == ViewBag.SelectedOtherUserId;

                    string chatUrl = ViewBag.IsSeller
                        ? Url.Action("Index", "Chat", new { buyerId = conv.OtherUserId })
                        : Url.Action("Index", "Chat", new { sellerId = conv.OtherUserId });

                    <a href="@chatUrl"
                       class="chat-list-item @(isActive ? "active" : "")"
                       data-name="@conv.DisplayName">

                        <img src="@conv.AvatarUrl" alt="Avatar" class="header-avatar">

                        <div class="chat-info">
                            <h6>@conv.DisplayName</h6>
                            <small class="text-muted">
                                @if (!string.IsNullOrEmpty(conv.LastMessage))
                                {
                                    @(conv.LastMessage.Length > 30 ? conv.LastMessage.Substring(0, 30) + "..." : conv.LastMessage)
                                }
                                else
                                {
                                    <text>Chưa có tin nhắn</text>
                                }
                            </small>
                            <div class="mt-1">
                                <small class="badge badge-info">@conv.OrderCount đơn hàng</small>
                                <small class="badge badge-primary">@conv.MessageCount tin nhắn</small>
                            </div>
                        </div>

                        <div class="chat-time">
                            <small>@conv.LastMessageTime.ToString("HH:mm")</small>
                        </div>
                    </a>
                }
            }
        </div>
    </div>

    <!-- ====================== MAIN CHAT AREA ===================== -->
    <div class="chat-main">

        <!-- HEADER -->
        <div class="chat-header">
            <div class="d-flex align-items-center">

                <img src="@ViewBag.OtherUserAvatar"
                     alt="Avatar"
                     class="header-avatar">

                <div class="ms-3">
                    <h6 class="mb-0">@ViewBag.OtherUserName</h6>
                    <small class="text-muted">
                        @if (ViewBag.SelectedOtherUserId != null)
                        {
                            <text>Online</text>
                        }
                        else
                        {
                            <text>Chưa chọn</text>
                        }
                    </small>
                </div>
            </div>

            @if (Model.Item1.Any())
            {
                <div class="ms-auto">
                    <small class="text-muted">@Model.Item1.Count đơn hàng</small>
                </div>
            }
        </div>

        <!-- MESSAGES -->
        <div class="chat-messages" id="chatMessages">

            @if (ViewBag.SelectedOtherUserId == null)
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-dots fs-1"></i>
                    <p class="mt-2">Chọn @(ViewBag.IsSeller ? "người mua" : "người bán") để bắt đầu trò chuyện</p>
                </div>
            }
            else if (!Model.Item2.Any())
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-text fs-1"></i>
                    <p class="mt-2">Chưa có tin nhắn. Hãy bắt đầu cuộc trò chuyện!</p>
                </div>
            }
            else
            {
                @foreach (var msg in Model.Item2)
                {
                    <div class="@(msg.SenderId == ViewBag.CurrentUserId ? "msg-me" : "msg-other")">
                        @msg.Message
                        <div class="msg-time">@msg.SentAt.ToString("HH:mm")</div>
                    </div>
                }
            }
        </div>

        <!-- INPUT -->
        @if (ViewBag.SelectedOtherUserId != null)
        {
            <div class="chat-input-area">

                <div class="chat-input-wrapper">
                    <button class="btn btn-light btn-sm"><i class="bi bi-emoji-smile"></i></button>
                    <button class="btn btn-light btn-sm"><i class="bi bi-image"></i></button>

                    <input type="text"
                           class="form-control message-input"
                           id="messageInput"
                           placeholder="Nhập tin nhắn..."
                           autocomplete="off">

                    <button class="btn btn-primary send-btn" id="sendBtn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        }
    </div>
</div>


<!-- ================== SIGNALR ================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

    // ================== SIGNALR - FIXED VERSION ==================
    const currentUserId = $("#currentUserId").val();
    const selectedSellerId = $("#selectedSellerId").val();
    const selectedBuyerId = $("#selectedBuyerId").val();
    const isSeller = $("#isSeller").val() === "True";

    console.log("Chat initialized:", {
        currentUserId,
        selectedSellerId,
        selectedBuyerId,
        isSeller
    });

    // Auto scroll to bottom
    function scrollToBottom() {
        const chatMessages = $("#chatMessages");
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }

    // Scroll to bottom on page load
    $(document).ready(function () {
        scrollToBottom();
    });

    // Search functionality
    $("#searchInput").on("keyup", function () {
        const value = $(this).val().toLowerCase();
        $("#chatList .chat-list-item").filter(function () {
            const name = $(this).data("name").toLowerCase();
            $(this).toggle(name.indexOf(value) > -1);
        });
    });

    if (selectedSellerId && selectedBuyerId) {

        const conn = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub?sellerId=" + selectedSellerId + "&buyerId=" + selectedBuyerId)
            .build();

        conn.on("ReceiveMessage", function (senderId, message) {

            const msgClass = senderId === currentUserId ? "msg-me" : "msg-other";
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                now.getMinutes().toString().padStart(2, '0');

            $("#chatMessages").append(`
            <div class="${msgClass}">
                ${message}
                <div class="msg-time">${timeStr}</div>
            </div>
        `);

            scrollToBottom();
        });

        conn.start().then(function () {
            console.log("SignalR connected successfully");
        }).catch(function (err) {
            console.error("SignalR connection error:", err);
        });

        // ======= Hàm chung gửi tin nhắn - FIXED =======
        function sendMessage() {
            const msg = $("#messageInput").val().trim();
            if (!msg) return;

            console.log("Sending message:", {
                sellerId: selectedSellerId,
                buyerId: selectedBuyerId,
                currentUserId: currentUserId,
                message: msg
            });

            // Gửi qua SignalR
            conn.invoke("SendMessage", selectedSellerId, selectedBuyerId, currentUserId, msg)
                .catch(function (err) {
                    console.error("Error sending message via SignalR:", err);
                });

            // ✅ FIXED: Lưu vào database với đầy đủ thông tin
            $.ajax({
                url: "/Chat/SendMessage",
                type: "POST",
                data: {
                    SellerId: selectedSellerId,
                    BuyerId: selectedBuyerId,
                    Message: msg
                },
                success: function (response) {
                    console.log("Message saved to database successfully");
                },
                error: function (xhr, status, error) {
                    console.error("Error saving message:", {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    alert("Không thể gửi tin nhắn. Vui lòng thử lại.");
                }
            });

            $("#messageInput").val("");
        }

        // === Click nút gửi ===
        $("#sendBtn").click(function () {
            sendMessage();
        });

        // === ENTER để gửi ===
        $("#messageInput").on("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

</script>