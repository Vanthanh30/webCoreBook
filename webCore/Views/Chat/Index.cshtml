@model Tuple<List<webCore.Models.Order>, List<webCore.Models.ChatMessage>>

<link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<input type="hidden" id="currentUserId" value="@ViewBag.CurrentUserId" />
<input type="hidden" id="otherUserId" value="@ViewBag.OtherUserId" />

<div class="chat-container">

    <!-- ======================== SIDEBAR =========================== -->
    <div class="chat-sidebar">
        <div class="sidebar-header">
            <h5>💬 Tin nhắn theo đơn hàng</h5>

            <div class="search-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Tìm đơn hàng...">
            </div>

            <select class="filter-select">
                <option value="all">Tất cả</option>
                <option value="unread">Có tin nhắn</option>
            </select>
        </div>

        <div class="chat-list">
            @foreach (var order in Model.Item1)
            {
                var hasMsg = ViewBag.OrdersWithMessages != null &&
                ((List<string>)ViewBag.OrdersWithMessages).Contains(order.Id.ToString());

                <a href="@Url.Action("Index", "Chat", new { orderId = order.Id })"
                   class="chat-list-item @(order.Id.ToString() == (ViewBag.OrderId ?? "") ? "active" : "")">

                    <div class="chat-avatar">
                        <img src="/images/avatar-default.png" />
                    </div>

                    <div class="chat-info">
                        <h6>@order.FullName</h6>
                        <small>ID: @order.Id</small>
                    </div>

                    @if (hasMsg)
                    {
                        <span class="badge bg-success">●</span>
                    }
                </a>
            }
        </div>
    </div>

    <!-- ====================== MAIN CHAT AREA ===================== -->
    <div class="chat-main">

        <!-- HEADER -->
        <div class="chat-header">
            <div class="d-flex align-items-center">

                <img src="/images/avatar-default.png"
                     alt="Avatar"
                     class="header-avatar">

                <div class="ms-3">
                    <h6 class="mb-0">
                        @(ViewBag.OrderId == null ? "Chọn đơn hàng để chat" : ViewBag.OtherUserId)
                    </h6>

                    <small class="text-muted">
                        @(ViewBag.OrderId == null ? "Chưa chọn" : "Online")
                    </small>
                </div>
            </div>
        </div>

        <!-- MESSAGES -->
        <div class="chat-messages" id="chatMessages">

            @if (ViewBag.OrderId == null)
            {
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-dots fs-1"></i>
                    <p class="mt-2">Chọn đơn hàng để bắt đầu trò chuyện</p>
                </div>
            }
            else
            {
                foreach (var msg in Model.Item2)
                {
                    <div class="@(msg.SenderId == ViewBag.CurrentUserId ? "msg-me" : "msg-other")">
                        @msg.Message
                    </div>
                }
            }
        </div>

        <!-- INPUT -->
        @if (ViewBag.OrderId != null)
        {
            <div class="chat-input-area">

                <div class="chat-input-wrapper">
                    <button class="btn btn-light btn-sm"><i class="bi bi-emoji-smile"></i></button>
                    <button class="btn btn-light btn-sm"><i class="bi bi-image"></i></button>

                    <input type="text"
                           class="form-control message-input"
                           id="messageInput"
                           placeholder="Nhập tin nhắn...">

                    <button class="btn btn-primary send-btn" id="sendBtn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        }
    </div>
</div>


<!-- ================== SIGNALR ================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

<script>

    const orderId = "@ViewBag.OrderId";
    const currentUserId = "@ViewBag.CurrentUserId";
    const otherUserId = "@ViewBag.OtherUserId";

    if (orderId) {

        const conn = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub?orderId=" + orderId)
            .build();

        conn.on("ReceiveMessage", function (sender, message) {

            $("#chatMessages").append(`
                    <div class="${sender == currentUserId ? "msg-me" : "msg-other"}">
                        ${message}
                    </div>
                `);

            $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
        });

        conn.start();

        $("#sendBtn").click(() => {

            const msg = $("#messageInput").val();
            if (!msg) return;

            conn.invoke("SendMessage", orderId, currentUserId, msg);

            $.post("/Chat/SendMessage", {
                OrderId: orderId,
                SenderId: currentUserId,
                ReceiverId: otherUserId,
                Message: msg
            });

            $("#messageInput").val("");
        });
    }

</script>