@{
    Layout = "_Layout";
    var categories = ViewBag.Categories as List<webCore.Models.Category>;
    var parentCategories = categories?.Where(c => c.ParentId == null).ToList();
    var groupedProducts = ViewBag.GroupedProducts as Dictionary<string, List<webCore.Models.Product_admin>>;
    var featuredProducts = ViewBag.FeaturedProducts as List<webCore.Models.Product_admin>;
    var bestsellerProducts = ViewBag.BestsellerProducts as List<webCore.Models.Product_admin>;
    var sortedProducts = ViewBag.SortedProducts as List<webCore.Models.Product_admin>;

    // Sắp xếp các nhóm sản phẩm theo thứ tự: Nổi bật, Mới, Gợi ý, Không nổi bật
    var orderedGroupedProducts = groupedProducts
        .Where(group => group.Key == "Nổi bật" || group.Key == "Mới" || group.Key == "Gợi ý" || group.Key == "Không nổi bật")
        .OrderBy(group =>
            group.Key == "Nổi bật" ? 0 :
            group.Key == "Mới" ? 1 :
            group.Key == "Gợi ý" ? 2 :
            group.Key == "Không nổi bật" ? 3 : int.MaxValue)
        .ToList();
}

<div class="container">
    <div class="row">
        <!-- Sidebar - Danh mục sản phẩm -->
        <aside class="list col-md-4">
            <ul class="list-group">
                <li class="inner-title list-group-item">
                    <h3>Danh mục sản phẩm</h3>
                </li>
                @if (parentCategories != null)
                {
                    foreach (var parent in parentCategories)
                    {
                        <li class="list-group-item" onclick="toggleArrow(this)">
                            <a>@parent.Title<span class="arrow"></span></a>
                            <ul class="list-group subcategories">
                                @foreach (var sub in categories.Where(c => c.ParentId == parent._id))
                                {
                                    <li class="list-group-item" onclick="event.stopPropagation(); loadProductsByCategoryId('@sub._id')">
                                        <a>@sub.Title</a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }
            </ul>

            <!-- Phần hiển thị Sách Bán Chạy - chỉ Featured 1,2,3 -->
            @if (bestsellerProducts != null && bestsellerProducts.Any())
            {
                <div class="featured-section mt-4">
                    <h4 class="featured-title">Sách Bán Chạy</h4>
                    <ul class="list-group">
                        @foreach (var product in bestsellerProducts.Take(5))
                        {
                            <li class="list-group-item">
                                <div class="row">
                                    <div class="col-4">
                                        <img src="@product.Image" class="img-fluid" alt="@product.Title" />
                                    </div>
                                    <div class="col-8">
                                        <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = product.Id })" class="product-title">
                                            @product.Title
                                        </a>
                                        @if (product.DiscountPercentage > 0)
                                        {
                                            <div>
                                                <span class="text-muted old-price">@string.Format("{0:N0}đ", product.Price)</span>
                                                <span class="new-price">@string.Format("{0:N0}đ", product.Price * (1 - product.DiscountPercentage / 100))</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="price">@string.Format("{0:N0}đ", product.Price)</div>
                                        }
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            }
        </aside>

        <!-- Main Content - Sản phẩm -->
        <main class="main col-md-8 p-3">
            <!-- Slideshow -->
            <div id="bookCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="4000">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#bookCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#bookCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#bookCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                </div>

                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/image/image_theme1.jpg" class="d-block w-100" alt="Theme 1" />
                    </div>
                    <div class="carousel-item">
                        <img src="/image/image_theme2.jpg" class="d-block w-100" alt="Theme 2" />
                    </div>
                    <div class="carousel-item">
                        <img src="/image/image_theme3.jpg" class="d-block w-100" alt="Theme 3" />
                    </div>
                </div>

                <button class="carousel-control-prev" type="button" data-bs-target="#bookCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#bookCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- Danh sách sản phẩm theo Featured 0,1,2,3 -->
            <div class="product-list mt-5">
                @if (orderedGroupedProducts != null && orderedGroupedProducts.Any())
                {
                    foreach (var group in orderedGroupedProducts)
                    {
                        <h3 class="product-group-name">@group.Key</h3>
                        <div class="position-relative">
                            <button class="scroll-btn scroll-left" onclick="scrollProducts(this, -300)">
                                &lt;
                            </button>

                            <div class="product-row">
                                @foreach (var product in group.Value)
                                {
                                    <div class="product-item">
                                        <div class="card">
                                            <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = product.Id })">
                                                <img src="@product.Image" class="card-img-top" alt="@product.Title" />
                                                <div class="card-body">
                                                    <h5 class="card-title">@product.Title</h5>
                                                    <p class="card-text">
                                                        @if (product.DiscountPercentage > 0)
                                                        {
                                                            <span class="badge discount-badge">
                                                                Giảm @product.DiscountPercentage%
                                                            </span>
                                                            <br />
                                                            <span class="text-muted old-price">
                                                                @string.Format("{0:N0}đ", product.Price)
                                                            </span>
                                                            <br />
                                                            <span class="price new-price">
                                                                @string.Format("{0:N0}đ", product.Price * (1 - product.DiscountPercentage / 100))
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="price normal-price">
                                                                @string.Format("{0:N0}đ", product.Price)
                                                            </span>
                                                        }
                                                    </p>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>

                            <button class="scroll-btn scroll-right" onclick="scrollProducts(this, 300)">
                                &gt;
                            </button>
                        </div>
                    }
                }
                else
                {
                    <p>Không có sản phẩm nào để hiển thị.</p>
                }
            </div>
        </main>
    </div>
</div>

<script>
    function toggleArrow(item) {
        const allItems = document.querySelectorAll("aside .list-group > .list-group-item");
        allItems.forEach(otherItem => {
            if (otherItem !== item) {
                otherItem.classList.remove("menu-active");
            }
        });
        item.classList.toggle("menu-active");
    }

    function loadProductsByCategoryId(categoryId) {
        fetch(`/Home/GetProductsByCategoryId?categoryId=${categoryId}`)
            .then(response => response.text())
            .then(html => {
                document.querySelector('.product-list').innerHTML = html;
            })
            .catch(error => console.error('Error loading products:', error));
    }

    function scrollProducts(button, distance) {
        const row = button.parentElement.querySelector('.product-row');
        row.scrollBy({
            left: distance,
            behavior: 'smooth'
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const subItems = document.querySelectorAll(".subcategories .list-group-item");

        subItems.forEach(item => {
            item.addEventListener("click", function () {
                subItems.forEach(i => i.classList.remove("active"));
                this.classList.add("active");
            });
        });

        document.addEventListener('click', function (e) {
            const sidebar = document.querySelector('aside.list');
            if (!sidebar.contains(e.target)) {
                const allItems = document.querySelectorAll("aside .list-group > .list-group-item");
                allItems.forEach(item => {
                    item.classList.remove("menu-active");
                });
            }
        });
    });
</script>

@functions {
    public string GetFeaturedLabel(string featured)
    {
        switch (featured)
        {
            case "Nổi bật": return "Nổi bật";
            case "Mới": return "Mới";
            case "Gợi ý": return "Gợi ý";
            case "Không nổi bật": return "Không nổi bật";
            default: return "";
        }
    }
}