@{
    Layout = "_Layout";
    var categories = ViewBag.Categories as List<webCore.Models.Category>;
    var parentCategories = categories?.Where(c => c.ParentId == null).ToList();
    var groupedProducts = ViewBag.GroupedProducts as Dictionary<string, List<webCore.Models.Product_admin>>;
    var featuredProducts = ViewBag.FeaturedProducts as List<webCore.Models.Product_admin>;
    var flashSaleProducts = ViewBag.FlashSaleProducts as List<webCore.Models.Product_admin>;

    // === SỬA CHÍNH TẠI ĐÂY ===
    var isSearching = ViewBag.IsSearching == true;
    var searchResults = ViewBag.SearchResults as List<KeyValuePair<string, List<Product_admin>>>;

    var displayGroups = isSearching && searchResults != null && searchResults.Any()
        ? searchResults
        : groupedProducts?
            .Where(g => g.Key == "Nổi bật" || g.Key == "Mới" || g.Key == "Gợi ý" || g.Key == "Bán chạy")
            .OrderBy(g => g.Key == "Nổi bật" ? 0 : g.Key == "Mới" ? 1 : 2)
            .Select(g => new KeyValuePair<string, List<Product_admin>>(g.Key, g.Value))
            .ToList() ?? new List<KeyValuePair<string, List<Product_admin>>>();
}

<style>
    .sub-categories {
        display: none;
        margin-left: 15px;
        margin-top: 5px;
    }

        .sub-categories.show {
            display: block;
        }

    /* Badge mới cho 3 phần chính */
    .section-badge {
        color: white;
        padding: 10px 25px;
        border-radius: 30px;
        font-weight: bold;
        font-size: 15px;
        display: inline-block;
        margin-bottom: 15px;
        text-transform: uppercase;
    }

        .section-badge.featured {
            background: #ff4757;
        }
        /* Đỏ nổi bật */
        .section-badge.new {
            background: #2ed573;
        }
        /* Xanh lá */
        .section-badge.bestseller {
            background: #1e90ff;
        }
    /* Xanh dương */
    .price-select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
    }
</style>

<div class="home-wrapper">
    <div class="container-fluid">
        <div class="row">
            <!-- SIDEBAR BÊN TRÁI -->
            <aside class="col-xl-2 col-lg-3 col-md-3 col-sm-12 pe-lg-3 mb-4 mb-lg-0">
                <div class="filter-sidebar">
                    <div class="filter-header">BỘ LỌC</div>

                    <!-- Lọc theo danh mục -->
                    <div class="filter-section">
                        <div class="filter-title">Lọc theo danh mục</div>
                        <div class="filter-options">
                            @if (parentCategories != null)
                            {
                                foreach (var parent in parentCategories)
                                {
                                    var subCategories = categories.Where(c => c.ParentId == parent._id).ToList();
                                    <div class="filter-item">
                                        <input type="checkbox" id="cat_@parent._id" class="filter-checkbox parent-checkbox"
                                               onchange="toggleSubCategories('@parent._id')" onclick="loadProductsByCategoryId('@parent._id')">
                                        <label for="cat_@parent._id">@parent.Title</label>
                                    </div>

                                    @if (subCategories.Any())
                                    {
                                        <div class="sub-categories" id="sub_@parent._id">
                                            @foreach (var sub in subCategories)
                                            {
                                                <div class="filter-item sub-item">
                                                    <input type="checkbox" id="subcat_@sub._id" class="filter-checkbox"
                                                           onclick="loadProductsByCategoryId('@sub._id')">
                                                    <label for="subcat_@sub._id">@sub.Title</label>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>

                    <!-- Lọc theo giá -->
                    <div class="filter-section filter-price-section">
                        <div class="filter-section filter-price-section">
                            <div class="filter-title">Lọc theo giá</div>
                            <select class="price-select" onchange="filterByPrice(this.value)">
                                <option value="">-- Chọn mức giá --</option>
                                <option value="0-50000">Dưới 50.000 đ</option>
                                <option value="50000-100000">50.000 – 100.000 đ</option>
                                <option value="100000-200000">100.000 – 200.000 đ</option>
                                <option value="200000-500000">200.000 – 500.000 đ</option>
                                <option value="500000-99999999">Trên 500.000 đ</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- FLASH SALE CHỈ HIỆN Ở SIDEBAR -->
                @if (flashSaleProducts != null && flashSaleProducts.Any())
                {
                    <div class="flash-sale-sidebar mt-4">
                        <div class="flash-sale-badge">FLASH SALE</div>
                        <div class="flash-sale-items">
                            @foreach (var product in flashSaleProducts)
                            {
                                <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = product.Id })" class="flash-item">
                                    @if (product.DiscountPercentage > 0)
                                    {
                                        <span class="flash-discount-tag">-@product.DiscountPercentage%</span>
                                    }
                                    <img src="@product.Image" alt="@product.Title" loading="lazy">
                                    <div class="flash-item-info">
                                        <div class="flash-item-title text-truncate">@product.Title</div>
                                        <div class="flash-item-old-price">@string.Format("{0:N0} đ", product.Price)</div>
                                        <div class="flash-item-price text-danger fw-bold">
                                            @string.Format("{0:N0} đ", product.Price * (1m - (decimal)product.DiscountPercentage / 100m))
                                        </div>
                                        <small class="text-muted">Giảm @product.DiscountPercentage%</small>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                }
            </aside>

            <!-- NỘI DUNG CHÍNH -->
            <main class="col-xl-10 col-lg-9 col-md-9 col-sm-12">
                <!-- Banner carousel -->
                <div class="main-banner mb-4">
                    <div id="bookCarousel" class="carousel slide rounded shadow" data-bs-ride="carousel" data-bs-interval="4000">

                        @* Danh sách ảnh hard-code *@
                        @{
                            var slideImages = new List<string>
                                                {
                                                "/image/image_theme1.jpg",
                                                "/image/image_theme2.jpg",
                                                "/image/image_theme3.jpg"
                                                };
                        }

                        <!-- Indicators -->
                        <div class="carousel-indicators">
                            @for (int i = 0; i < slideImages.Count; i++)
                            {
                                <button type="button"
                                        data-bs-target="#bookCarousel"
                                        data-bs-slide-to="@i"
                                        class="@(i == 0 ? "active" : "")"
                                        aria-current="@(i == 0 ? "true" : "false")">
                                </button>
                            }
                        </div>

                        <!-- Slideshow images -->
                        <div class="carousel-inner rounded">
                            @for (int i = 0; i < slideImages.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@slideImages[i]" class="d-block w-100 rounded" alt="Slide @(i + 1)">
                                </div>
                            }
                        </div>

                    </div>
                </div>


                <!-- Tab danh mục (cuộn ngang) -->
                <div class="category-tabs-container mb-4">
                    <button class="scroll-arrow left" onclick="scrollTabs(-1)">‹</button>
                    <div class="category-tabs" id="categoryTabs">
                        @if (parentCategories != null)
                        {
                            foreach (var cat in parentCategories)
                            {
                                <a href="javascript:void(0)"
                                   class="category-tab"
                                   data-category-id="@cat._id"
                                   onclick="loadProductsByCategoryId('@cat._id')">
                                    @cat.Title
                                </a>
                            }
                        }
                    </div>
                    <button class="scroll-arrow right" onclick="scrollTabs(1)">›</button>
                </div>
                <!-- 3 NHÓM SẢN PHẨM CHÍNH: NỔI BẬT - MỚI NHẤT - BÁN CHẠY -->
                <div class="product-list">
                    @if (displayGroups.Any())
                    {
                        foreach (var group in displayGroups)
                        {
                            var sectionTitle = group.Key switch
                            {
                                "Nổi bật" => "NỔI BẬT",
                                "Mới" => "MỚI NHẤT",
                                "Gợi ý" => "GỢI Ý",
                                "Bán chạy" => "BÁN CHẠY",
                                _ => group.Key.ToUpper()
                            };

                            var sectionClass = group.Key switch
                            {
                                "Nổi bật" => "featured",
                                "Mới" => "new",
                                "Gợi ý" => "bestseller",
                                _ => "bestseller"
                            };

                            <div class="product-section mb-5" data-section-type="@group.Key">
                                <h2 class="section-badge @sectionClass">@sectionTitle</h2>

                                <div class="products-slider-wrapper position-relative">
                                    <button class="slider-arrow left" onclick="slideProducts(this, -1)">‹</button>
                                    <div class="products-slider d-flex overflow-hidden">
                                        @foreach (var product in group.Value)
                                        {
                                            <div class="product-box me-3 flex-shrink-0" style="width: 220px;">
                                                <a href="@Url.Action("DetailProduct", "DetailProduct", new { id = product.Id })" class="text-decoration-none">
                                                    @if (product.DiscountPercentage > 0)
                                                    {
                                                        <span class="product-discount-badge">-@product.DiscountPercentage%</span>
                                                    }
                                                    <div class="product-img-wrapper bg-light rounded">
                                                        <img src="@product.Image" alt="@product.Title" class="w-100 rounded" loading="lazy" style="height: 280px; object-fit: cover;">
                                                    </div>
                                                    <div class="product-details mt-2">
                                                        <h3 class="product-name text-dark mb-1" style="font-size: 14px; height: 40px; overflow: hidden;">@product.Title</h3>
                                                        <div class="product-price-area">
                                                            @if (product.DiscountPercentage > 0)
                                                            {
                                                                <div class="product-price-old">
                                                                    <del>@string.Format("{0:N0} đ", product.Price)</del>
                                                                </div>
                                                                <div class="product-price-new">
                                                                    @string.Format("{0:N0} đ", product.Price * (1m - (decimal)product.DiscountPercentage / 100m))
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="product-price-single">
                                                                    @string.Format("{0:N0} đ", product.Price)
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                </a>
                                            </div>
                                        }
                                    </div>
                                    <button class="slider-arrow right" onclick="slideProducts(this, 1)">›</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center py-5 fs-4 text-muted">Không có sản phẩm nào để hiển thị.</p>
                    }
                </div>
            </main>
        </div>
    </div>
</div>

<!-- SCRIPT -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
<script>
    let currentCategoryId = "";

    function toggleSubCategories(parentId) {
        const sub = document.getElementById('sub_' + parentId);
        const checkbox = document.getElementById('cat_' + parentId);
        if (sub && checkbox) {
            sub.classList.toggle('show', checkbox.checked);
        }
    }

    function loadProductsByCategoryId(categoryId) {
        currentCategoryId = categoryId;

        fetch(`/Home/GetProductsByCategoryId?categoryId=${categoryId}`)
            .then(r => r.text())
            .then(html => {
                document.querySelector('.product-list').innerHTML = html;
            })
            .catch(err => console.error(err));
    }

    function filterByPrice(value) {
        if (!value) return;

        const [min, max] = value.split('-');

        fetch(`/Home/GetProductsByPrice?min=${min}&max=${max}`)
            .then(r => r.text())
            .then(html => {
                document.querySelector('.product-list').innerHTML = html;
            })
            .catch(err => console.error(err));
    }

    function scrollTabs(dir) {
        const el = document.querySelector('.category-tabs');
        el.scrollBy({ left: dir * 200, behavior: 'smooth' });
    }

    function slideProducts(btn, dir) {
        const slider = btn.parentElement.querySelector('.products-slider');
        slider.scrollBy({ left: dir * 260, behavior: 'smooth' });
    }
</script>
} 
}